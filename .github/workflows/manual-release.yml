name: Manual Release Trigger

# This workflow allows manual triggering of releases with custom version bumps
# Use this when you want explicit control over major/minor version increments

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Select version bump type'
        required: true
        type: choice
        options:
          - patch  # Bug fixes and minor changes (0.1.0 -> 0.1.1)
          - minor  # New features, backwards compatible (0.1.0 -> 0.2.0)
          - major  # Breaking changes (0.1.0 -> 1.0.0)
        default: patch
      dry-run:
        description: 'Dry run - calculate version but do not create release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  trigger-release:
    name: Trigger Release Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version (dry run)
        if: inputs.dry-run
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"

          case "${{ inputs.version-type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "DRY RUN: Would bump version from $LATEST_VERSION to $NEW_VERSION"
          echo "Bump type: ${{ inputs.version-type }}"

      - name: Trigger release workflow
        if: ${{ !inputs.dry-run }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: 'main',
              inputs: {
                'version-bump': '${{ inputs.version-type }}'
              }
            });
            console.log('Release workflow triggered with version bump: ${{ inputs.version-type }}');
